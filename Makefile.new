# AOC Timer Map - WORKING Commands (Manual Process)
.PHONY: help rebuild test-rebuild

help:
	@echo "🎯 AOC Timer Map - WORKING COMMANDS"
	@echo "=================================="
	@echo ""
	@echo "📋 Available commands:"
	@echo "  rebuild      - WORKING rebuild process (use this for dev)"
	@echo "  test-rebuild - Test rebuild with verification"
	@echo ""
	@echo "🔐 Default login: invicta / invicta"
	@echo "🌐 Access: http://localhost:9090"

# WORKING rebuild process - exact manual commands that work
rebuild:
	@echo "🔧 WORKING Manual rebuild process..."
	@echo "1. Building Angular frontend..."
	@cd app/frontend-dev && rm -rf dist/ && npm run build
	@echo "2. Copying built files from browser folder..."
	@rm -rf app/frontend-built/*
	@cp -r app/frontend-dev/dist/aoc-map/browser/* app/frontend-built/
	@echo "3. Verifying critical files:"
	@echo "   Title: $$(grep '<title>' app/frontend-built/index.html)"
	@echo "   Base href: $$(grep 'base href' app/frontend-built/index.html)"
	@echo "4. Stopping existing container..."
	@docker stop aoc-timer-map 2>/dev/null || true
	@docker rm aoc-timer-map 2>/dev/null || true
	@echo "5. Building Docker image..."
	@docker build -t aoctimermap_timer-map .
	@echo "6. Starting container..."
	@docker run -d \
		--name aoc-timer-map \
		-p 9090:80 \
		-v "$$(pwd)/data/database:/app/database:Z" \
		-v "$$(pwd)/data/backups:/app/backups:Z" \
		-v "$$(pwd)/.htpasswd:/app/.htpasswd:ro" \
		aoctimermap_timer-map
	@sleep 3
	@echo "✅ Rebuild complete! Access: http://localhost:9090"

# Test rebuild with verification
test-rebuild: rebuild
	@echo "🧪 Testing rebuild results..."
	@echo "1. Served title: $$(curl -u 'invicta:invicta' -s 'http://localhost:9090/' | grep -o '<title>.*</title>')"
	@echo "2. Served base href: $$(curl -u 'invicta:invicta' -s 'http://localhost:9090/' | grep 'base href')"
	@echo "3. Red background test: $$(curl -u 'invicta:invicta' -s 'http://localhost:9090/' | grep -o 'background-color:#ff0000' || echo 'NOT FOUND')"
	@echo "4. Timer API test: $$(curl -u 'invicta:invicta' -X PUT -H 'Content-Type: application/json' -d '{\"mob_id\": 26}' -s 'http://localhost:9090/named_mobs_api.php/named-mobs/reset-timer' | jq -r '.message')"
	@echo "✅ Test complete!"
